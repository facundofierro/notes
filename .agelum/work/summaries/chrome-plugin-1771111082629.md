---
created: 2026-02-14T00:00:00.000Z
task: .agelum/work/tasks/fixes/chrome-plugin.md
plan: .agelum/work/plans/chrome-plugin-1771106302323.md
---

# Chrome Plugin Enhancement Summary

## Overview

Completed the four remaining items from the implementation audit for the Chrome plugin feature set.

---

## Changes Made

### 1. Inbox Enhanced Card View (Task 4)
**File:** `packages/kanban/src/components/KanbanCard.tsx`

- Updated priority color scheme to match requested red/orange/yellow convention:
  - `low` → `text-yellow-500` (was `text-muted-foreground`)
  - `medium` → `text-orange-500` (was `text-blue-500`)
  - `high` → `text-red-500` (was `text-orange-500`)
  - `urgent` → `text-red-600` (was `text-red-500`)
- Added a compact **inbox-specific card layout** (`isInbox = card.columnId === "inbox"`):
  - Renders a thinner card with a **colored left border** indicating priority (yellow/orange/red)
  - Shows the task title (2-line clamp) and reporter email below
  - Priority label shown as right-aligned colored text
  - Uses `border-l-sky-500` as fallback when no priority is set

### 2. Web App Gateway Route (Task 2)
**Files created:**
- `apps/web/src/app/api/(auth)/gateway/route.ts` — Main CRUD for stored site token
- `apps/web/src/app/api/(auth)/gateway/login/route.ts` — Starts OAuth flow (redirects to Site app)
- `apps/web/src/app/api/(auth)/gateway/callback/route.ts` — Handles OAuth callback, stores token, redirects to Chrome extension

**`apps/web/src/lib/settings.ts`** — Added two optional fields to `UserSettings`:
- `siteToken?: string` — Stored OAuth token from the Site app
- `siteUser?: { email, name, image }` — Cached user info

The gateway flow:
1. Chrome extension calls `/api/gateway/login?redirect_uri={ext_url}&provider={github|google}`
2. Web app redirects to Site app's OAuth signin with callback pointing to `/api/gateway/callback`
3. After successful auth, callback fetches session from Site app, generates a token, saves it locally, and redirects to the Chrome extension callback URL with `?token=...&email=...&name=...`

### 3. SettingsPlugin Auth Section (Task 3)
**File:** `apps/web/src/components/features/settings/SettingsPlugin.tsx`

Added a **"Developer Account"** section at the top of the plugin settings panel:
- Checks auth status via `GET /api/gateway` on mount
- **Not authenticated**: Shows explanation about cloud registry benefits + "Login with GitHub" button that opens the Site app's signin page in a new tab
- **Authenticated**: Shows connected user email with a green status indicator, and a Logout button that calls `DELETE /api/gateway`
- Shows offline indicator when the Site app is unreachable but a cached token exists

### 4. Chrome Plugin OAuth Login (Task 1)
**Files modified:**
- `apps/chrome-plugin/manifest.json` — Added `"identity"` permission
- `apps/chrome-plugin/src/shared/storage.ts` — Added `OAuthUser` interface; added `oauthToken` and `oauthUser` fields to `ConnectionSettings`
- `apps/chrome-plugin/src/shared/api-client.ts` — Updated `createReport` to prefer `oauthToken` over `apiKey` for authorization
- `apps/chrome-plugin/src/sidepanel/App.tsx` — Updated auth check to accept either `apiKey` or `oauthToken`
- `apps/chrome-plugin/src/popup/App.tsx` — Full redesign:
  - Added tabbed interface: **"Connection"** tab (server URL, API key, project) and **"Account"** tab
  - **Account tab (logged out)**: Shows explanation + "Continue with GitHub" and "Continue with Google" buttons using `chrome.identity.launchWebAuthFlow` pointing to the Web App gateway
  - **Account tab (logged in)**: Shows user avatar initial, name, email, provider; logout button
  - **Connection tab**: Shows logged-in user info badge instead of manual reporter email field when authenticated
  - Reporter email auto-fills from OAuth user after login

---

## Architecture

```
Chrome Plugin popup
  └── Account tab
        └── chrome.identity.launchWebAuthFlow
              └── Web App /api/gateway/login  (redirects to Site app)
                    └── Site app OAuth (GitHub/Google)
                          └── Web App /api/gateway/callback  (stores token)
                                └── Chrome extension redirect with token+email
```

---

## What Remains / Future Work

- The Web App gateway callback uses a simple base64 token rather than a signed JWT — in production this should use proper JWT signing with a secret key
- The Site app's NextAuth is configured with a fixed signin page; the gateway assumes it will redirect correctly based on the `callbackUrl` parameter — this may need additional configuration on the Site app side
- Yandex OAuth provider support in the Chrome plugin (currently only GitHub + Google)
