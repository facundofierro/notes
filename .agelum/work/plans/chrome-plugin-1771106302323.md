# Implementation Plan - Chrome Plugin Enhancement

This plan covers the implementation of a comprehensive authentication flow, configuration settings, and an "Inbox" functionality for the Agelum Chrome plugin within the monorepo.

## Objectives
1.  **Unified Authentication:** Implement a secure OAuth flow (GitHub for devs, Google/Yandex for plugin users) via a gateway in the Web app.
2.  **Plugin Management:** Allow developers to enable specific users (by email) and configure project/domain mappings for the plugin.
3.  **Inbox Workflow:** Introduce an "Inbox" column in the Kanban board to receive and process tasks reported via the Chrome plugin.

---

## Phase 1: Authentication & User Registry (Site App)
**Goal:** Establish `apps/site` as the central identity provider and registry.

1.  **OAuth Integration:**
    *   Configure NextAuth (or equivalent) in `apps/site` to support GitHub, Google, and Yandex providers.
    *   Ensure tokens are issued securely.
2.  **User Registry API:**
    *   Implement `/api/v1/users/register` to handle user profile creation upon first OAuth login.
    *   Implement `/api/v1/users/verify` to check if a user is authorized for a specific project/plugin.
3.  **Source of Truth:**
    *   Store user data in `apps/site` (database or structured storage in `.agelum` root).

## Phase 2: Auth Gateway & Settings UI (Web App)
**Goal:** Implement the gateway in the Web app and update the settings interface.

1.  **Web App Gateway:**
    *   Create `apps/web/src/app/api/(auth)/gateway/route.ts` to proxy authentication requests to `apps/site`.
    *   Manage session tokens locally in the Web app server/Electron.
2.  **Settings UI Update:**
    *   Modify `apps/web/src/components/features/settings/SettingsPlugin.tsx`:
        *   Show "Login" button if not authenticated.
        *   Provide an explanation of why login is required for advanced plugin features.
        *   Implement logout functionality.
3.  **Token Management:**
    *   Securely store the gateway token in `user-settings.json` (encrypted if possible, or at least handled via the server).

## Phase 3: Plugin Configuration Settings (Web App)
**Goal:** Allow granular control over plugin access and behavior.

1.  **User Enablement (Whitelisting):**
    *   Add a section in `SettingsPlugin.tsx` to manage a list of allowed emails for the plugin.
    *   Store this list in `.agelum/config/users.json` within the project repository.
2.  **Project & Domain Mapping:**
    *   Add configuration fields for:
        *   **Project Name:** The display name shown in the plugin.
        *   **Domain:** The domain (e.g., `myapp.com`) for auto-identifying the project when the plugin is opened on that site.
    *   Update `ProjectConfig` interface in `apps/web/src/lib/settings.ts` to include these fields.

## Phase 4: Inbox Backend Implementation (Web App)
**Goal:** Support the "Inbox" state for tasks and images.

1.  **State Directory:**
    *   Update `ensureAgelumStructure` in `apps/web/src/app/api/(content)/tasks/route.ts` to create `.agelum/work/tasks/inbox`.
2.  **API Enhancements:**
    *   Modify `readTasks` to include tasks from the `inbox` directory.
    *   Update `moveTask` logic to handle transitions from `inbox` to other states.
3.  **Image Handling:**
    *   Ensure the `images` directory in `.agelum/work/tasks/` correctly stores screenshots received from the plugin.

## Phase 5: Kanban Inbox UI (Web App & Kanban Package)
**Goal:** Provide a dedicated space for incoming tasks in the UI.

1.  **Kanban Column:**
    *   Add `inbox` column definition to `apps/web/src/components/features/kanban/TaskKanban.tsx`.
    *   Ensure it is positioned as the leftmost column.
2.  **Styling & Components:**
    *   Update `packages/kanban/src/components/KanbanColumn.tsx` (or app-specific CSS) to support a "thinner" fixed width for the Inbox.
    *   Implement a specialized `InboxTaskCard` (or conditional rendering in `KanbanCard`) that shows:
        *   Creator/Reporter name/email.
        *   Priority color indicators (Red/Orange/Yellow) based on task metadata.
3.  **Drag-and-Drop Workflow:**
    *   Enable dragging from `Inbox` to `Backlog`, `Fixes`, etc.
    *   Upon drop, update the task file's frontmatter state and move it to the corresponding directory.

## Phase 6: Chrome Plugin Integration
**Goal:** Connect the plugin to the new backend flow.

1.  **API Client Update:**
    *   Update `apps/chrome-plugin/src/shared/api-client.ts` to use the Web App gateway URL if applicable.
    *   Update authorization headers to use the new token-based flow.
2.  **Metadata Capture:**
    *   Ensure the plugin sends the `reporter` email and `priority` level in the task creation request.
