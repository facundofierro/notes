---
created: 2026-02-11T18:00:00.000Z
type: plan
task: chrome-plugin
---

# Chrome Plugin for Issue Reporting - Implementation Plan

## Context

Agelum already has a robust screenshot annotation workflow inside `BrowserTab` (Electron/web capture) + `ScreenshotViewer` (SVG drawing) + `TaskPanel` (burn-in + task creation). The goal is to bring this same experience to any website via a Chrome extension, paired with a new `apps/site` backend that acts as the API gateway.

This is a large task split into **7 phases**. Each phase is self-contained and produces working artifacts.

---

## Architecture Overview

```
monorepo root
├── apps/
│   ├── chrome-plugin/     (NEW - Vite + React, Chrome Manifest V3)
│   ├── site/              (NEW - Next.js 15, landing page + API gateway)
│   ├── web/               (existing - modified)
│   └── electron/          (existing - unchanged)
├── packages/
│   ├── annotation/        (NEW - shared types, colors, burn-in, arrowhead)
│   ├── shadcn/            (existing)
│   ├── kanban/            (existing)
│   └── llm-provider/      (existing)
```

The `pnpm-workspace.yaml` already uses `apps/*` and `packages/*` globs, so new directories are auto-detected.

---

## Phase 1: Shared Annotation Package (`packages/annotation`)

**Goal**: Extract annotation types, colors, arrowhead math, and burn-in canvas logic from `apps/web` into a reusable package.

### Files to Create

| File | Purpose |
|------|---------|
| `packages/annotation/package.json` | `@agelum/annotation`, tsup build (CJS + ESM + DTS) |
| `packages/annotation/tsconfig.json` | ES2020 target, DOM lib, strict |
| `packages/annotation/tsup.config.ts` | Entry `src/index.ts`, same pattern as `packages/shadcn/tsup.config.ts` |
| `packages/annotation/src/index.ts` | Re-exports all modules |
| `packages/annotation/src/types.ts` | `Annotation`, `AnnotationType` - extracted from `apps/web/src/types/entities.ts:60-72` |
| `packages/annotation/src/colors.ts` | `ANNOTATION_COLORS` constant: modify (orange `#f59e0b`), arrow (blue `#3b82f6`), remove (red `#dc2626`) with fill/stroke/badge variants |
| `packages/annotation/src/arrowhead.ts` | `computeArrowheadPoints(x1, y1, x2, y2, length)` - trigonometry from `ScreenshotViewer.tsx` |
| `packages/annotation/src/burn-in.ts` | `burnAnnotations({ screenshotDataUrl, annotations, displayWidth, displayHeight }) → Promise<string>` - canvas logic from `TaskPanel.tsx:967-1107` |
| `packages/annotation/src/render-svg.ts` | `getAnnotationSVGAttrs(ann)` - returns SVG element attributes for each annotation type |

### Files to Modify

| File | Change |
|------|--------|
| `apps/web/package.json` | Add `"@agelum/annotation": "workspace:*"` |
| `apps/web/src/types/entities.ts` | Replace inline `AnnotationType` + `Annotation` (lines 60-72) with re-export from `@agelum/annotation` |
| `apps/web/src/components/features/browser/capture/ScreenshotViewer.tsx` | Import `computeArrowheadPoints`, `ANNOTATION_COLORS` from `@agelum/annotation` |
| `apps/web/src/components/features/browser/panels/TaskPanel.tsx` | Replace inline burn-in (lines 967-1107) with call to `burnAnnotations()` from `@agelum/annotation` |

### Key Implementation Detail: `burn-in.ts`

```ts
export async function burnAnnotations(opts: BurnInOptions): Promise<string> {
  // 1. Load screenshot into Image, get naturalWidth/naturalHeight
  // 2. Create canvas at natural dimensions
  // 3. Draw screenshot
  // 4. Calculate scale: scaleX = naturalWidth / displayWidth
  // 5. For each annotation: map display coords → natural coords
  //    - Boxes: stroke rect + fill rect + badge circle
  //    - Arrows: line + arrowhead polygon + badge circle
  //    - Remove: same as box + "REMOVE THIS" label
  // 6. Return canvas.toDataURL("image/png")
}
```

---

## Phase 2: Chrome Extension Scaffolding (`apps/chrome-plugin`)

**Goal**: Set up the Vite-based Chrome Manifest V3 project with React, Tailwind, and monorepo integration.

### Directory Structure

```
apps/chrome-plugin/
├── package.json            # @agelum/chrome-plugin, Vite build
├── tsconfig.json
├── vite.config.ts          # Multi-entry: sidepanel, popup, background, content
├── tailwind.config.js
├── postcss.config.js
├── manifest.json           # Manifest V3
├── public/icons/           # icon16.png, icon48.png, icon128.png
└── src/
    ├── shared/
    │   ├── messages.ts     # Typed message protocol (CaptureRequest, InjectOverlay, etc.)
    │   ├── storage.ts      # chrome.storage.local helpers for ConnectionSettings
    │   └── api-client.ts   # fetch wrapper for POST /api/v1/reports
    ├── sidepanel/          # React app
    ├── popup/              # React app (minimal settings form)
    ├── background/         # Service worker
    └── content/            # Content script + overlay
```

### `manifest.json`

```json
{
  "manifest_version": 3,
  "name": "Agelum Issue Reporter",
  "version": "0.1.0",
  "permissions": ["activeTab", "sidePanel", "storage"],
  "action": { "default_popup": "popup/index.html" },
  "side_panel": { "default_path": "sidepanel/index.html" },
  "background": { "service_worker": "background/service-worker.js", "type": "module" },
  "content_scripts": [{
    "matches": ["<all_urls>"],
    "js": ["content/content-script.js"],
    "css": ["content/overlay-styles.css"],
    "run_at": "document_idle"
  }]
}
```

### `vite.config.ts`

Multi-entry Rollup config with 4 inputs: sidepanel HTML, popup HTML, background service-worker, content script. A custom plugin copies `manifest.json` and `public/icons/` to `dist/` after build.

### Message Protocol (`src/shared/messages.ts`)

```ts
type ExtensionMessage =
  | { type: "CAPTURE_TAB" }                                    // SidePanel → Background
  | { type: "CAPTURE_RESULT"; dataUrl: string; tabId: number } // Background → SidePanel
  | { type: "INJECT_OVERLAY"; screenshotDataUrl: string }      // Background → Content
  | { type: "SET_TOOL"; tool: AnnotationType }                 // SidePanel → Content
  | { type: "ANNOTATIONS_COMPLETE"; annotations: Annotation[]; displayWidth: number; displayHeight: number } // Content → SidePanel
  | { type: "OVERLAY_DISMISSED" }                              // Content → SidePanel
```

### Storage (`src/shared/storage.ts`)

```ts
interface ConnectionSettings {
  serverUrl: string;   // e.g. "http://localhost:6500"
  apiKey: string;      // "ak_..."
  projectRepo: string; // which repo to create tasks in
}
```

### Root `package.json` - Add Scripts

```json
"chrome:dev": "pnpm --filter @agelum/chrome-plugin dev",
"chrome:build": "pnpm --filter @agelum/chrome-plugin build",
"site:dev": "pnpm --filter @agelum/site dev",
"site:build": "pnpm --filter @agelum/site build"
```

---

## Phase 3: Content Script Drawing Overlay

**Goal**: Implement the full-screen annotation overlay injected into the active tab. Uses **vanilla TypeScript** (no React) to keep the content script small (~40KB savings).

### Files

| File | Purpose |
|------|---------|
| `src/content/content-script.ts` | Listens for `INJECT_OVERLAY`/`SET_TOOL` messages, creates/destroys `AnnotationOverlay` |
| `src/content/overlay/AnnotationOverlay.ts` | Core class (~400 lines): creates fixed overlay, draws SVG annotations, handles mouse events |
| `src/content/overlay/overlay-styles.css` | Minimal reset CSS for the overlay container |

### `AnnotationOverlay` Class

Replicates `ScreenshotViewer.tsx` behavior exactly:

1. **Container**: Fixed position div, `z-index: 2147483647`, dark semi-transparent background
2. **Toolbar**: Top bar with Modify/Arrow/Remove/Done/Cancel buttons
3. **Image**: `<img>` with captured screenshot, `max-width/max-height: 100%`
4. **SVG Overlay**: Absolute-positioned over image, `pointer-events: none`
5. **Mouse Events**: On wrapper div (not SVG). Calculates coords relative to image bounds
6. **Drawing Logic**:
   - Modify: orange rect, min 5x5px
   - Arrow: blue line + arrowhead polygon, min 10px distance
   - Remove: red rect + "REMOVE THIS" label
7. **Live Preview**: Dashed stroke while drawing
8. **Badges**: Colored numbered circles at annotation origin
9. **Keyboard**: ESC to dismiss overlay
10. **Completion**: "Done" sends `ANNOTATIONS_COMPLETE` message with annotations array + display dimensions

Imports `Annotation`, `AnnotationType`, `ANNOTATION_COLORS`, `computeArrowheadPoints` from `@agelum/annotation`.

---

## Phase 4: SidePanel, Popup, and Background Script

**Goal**: Implement React-based SidePanel (control center), minimal Popup (settings), and Background Script (message routing + capture).

### Background Script (`src/background/service-worker.ts`)

- Handles `CAPTURE_TAB`: calls `chrome.tabs.captureVisibleTab()`, sends `INJECT_OVERLAY` to content script, opens side panel
- Forwards `ANNOTATIONS_COMPLETE`/`OVERLAY_DISMISSED` from content script to SidePanel
- For large screenshots (>5MB data URLs): uses `chrome.storage.session` as transfer buffer

### SidePanel (`src/sidepanel/`)

React app with states: `idle → capturing → annotating → prompting → submitting`

| Component | Purpose |
|-----------|---------|
| `App.tsx` | Main state machine, message listener, orchestrates flow |
| `components/ToolSelector.tsx` | 3 tool buttons (Modify/Arrow/Remove), forwards tool changes to content script |
| `components/AnnotationPromptList.tsx` | List of annotations with colored badges + text input for each prompt (port of `apps/web` version) |
| `components/GeneralPrompt.tsx` | General instructions textarea |
| `components/StatusBar.tsx` | Connection status, error display |
| `components/ScreenshotPreview.tsx` | Small thumbnail of captured screenshot |

**Submit flow**: Calls `burnAnnotations()` from `@agelum/annotation` → builds markdown description → POSTs to `/api/v1/reports` via `api-client.ts`.

### Popup (`src/popup/`)

Minimal React form with 3 fields:
- Server URL (default: `http://localhost:6500`)
- API Key (password input)
- Project/Repo Name

Saves to `chrome.storage.local` via `storage.ts`. Button to open SidePanel.

### Styles

Both SidePanel and Popup include `globals.css` with Tailwind directives + dark theme CSS variables copied from `apps/web/src/app/globals.css`.

---

## Phase 5: `apps/site` - API Gateway and Landing Page

**Goal**: Next.js 15 app on port 6600 serving as the API gateway for the Chrome plugin.

### Directory Structure

```
apps/site/
├── package.json          # @agelum/site, Next.js 15, port 6600
├── tsconfig.json
├── next.config.js
├── tailwind.config.js
├── postcss.config.js
└── src/
    ├── app/
    │   ├── layout.tsx
    │   ├── page.tsx       # Landing page (minimal initially)
    │   ├── globals.css
    │   └── api/v1/reports/route.ts  # Main Chrome plugin endpoint
    ├── lib/
    │   ├── auth.ts        # API key validation (reads ~/.agelum/api-keys.json)
    │   ├── cors.ts        # CORS headers for extension origin
    │   └── task-creator.ts # Creates .agelum task files on disk
    └── types/api.ts
```

### API Endpoint: `POST /api/v1/reports`

**Request**:
```ts
{
  repo: string;              // Project name
  title: string;             // Task title
  description: string;       // Markdown with annotations
  screenshotDataUrl: string; // Burned-in PNG as base64 data URL
  state: string;             // "fixes" (default)
  sourceUrl: string;         // URL where screenshot was taken
}
```

**Headers**: `Authorization: Bearer ak_...`

**Flow**:
1. CORS preflight handling (`OPTIONS` method)
2. Validate API key via `auth.ts` (hashes key, checks against `~/.agelum/api-keys.json`)
3. Resolve project path from settings (`~/.agelum/user-settings.json` → `projects[]`)
4. Save screenshot PNG to `.agelum/work/tasks/images/{timestamp}-{title}.png`
5. Create task markdown at `.agelum/work/tasks/{state}/{timestamp}-{title}.md`
6. Return `{ success: true, path, id }`

### `lib/auth.ts`

- Reads API keys from `~/.agelum/api-keys.json` (array of `{ id, key (SHA-256 hash), name, userId, createdAt, lastUsedAt }`)
- `validateApiKey(key)`: hashes input, finds matching entry, updates `lastUsedAt`
- `generateApiKey()`: creates `ak_` prefixed key, stores hash, returns raw key once

### `lib/task-creator.ts`

Replicates task creation from `apps/web/src/app/api/(content)/tasks/route.ts`:
- `getTimestampPrefix()`: `YY_MM_DD-HHMMSS` format
- `sanitizeTitle()`: filesystem-safe title
- Creates frontmatter with `created`, `state`, `source: chrome-plugin`
- Includes markdown with screenshot embed and annotation descriptions

---

## Phase 6: Authentication System

**Goal**: Add API key generation/management to `apps/web` and wire validation in `apps/site`.

### New API Route: `apps/web/src/app/api/(auth)/api-keys/route.ts`

| Method | Action |
|--------|--------|
| `POST` | Generate new API key → returns raw key once (stored as SHA-256 hash in `~/.agelum/api-keys.json`) |
| `GET` | List keys (id, name, createdAt, lastUsedAt - NO raw key) |
| `DELETE` | Revoke key by id |

### Modifications to `apps/web`

| File | Change |
|------|--------|
| `apps/web/src/lib/settings.ts` | Add `PluginApiKey` interface, add `pluginApiKeys: PluginApiKey[]` to `UserSettings` and `defaultSettings` |

### Settings UI

Add a section in the existing settings panel:
- List of API keys (name, created date, last used)
- "Generate New Key" button → shows raw key once with copy button
- "Revoke" button per key

---

## Phase 7: Integration and Polish

**Goal**: Wire everything together and handle edge cases.

### End-to-End Flow

1. User installs extension, configures server URL + API key in popup
2. Navigates to any webpage, opens SidePanel
3. Clicks "Capture" → Background captures tab → Content script shows overlay
4. User draws annotations, clicks "Done"
5. SidePanel receives annotations, shows prompt editor
6. User adds prompts, clicks "Create Task"
7. SidePanel burns annotations into image → POSTs to `apps/site/api/v1/reports`
8. `apps/site` validates key, creates task file in project's `.agelum/work/tasks/`

### Edge Cases

| Case | Solution |
|------|----------|
| `chrome://` pages (no content script) | SidePanel falls back to embedded annotation mode |
| Large screenshots (>5MB data URL) | Use `chrome.storage.session` as transfer buffer |
| Multiple tabs | Store current capture tabId, only accept annotations from that tab |
| Missing API key | SidePanel shows "Not connected" status with link to popup |

### Build Workflow

```bash
pnpm chrome:dev    # Vite watch mode → dist/
pnpm chrome:build  # Production build

# Load in Chrome:
# chrome://extensions/ → Developer Mode → Load unpacked → apps/chrome-plugin/dist/
```

---

## Verification

1. **Package build**: `cd packages/annotation && pnpm build` succeeds, `apps/web` still builds with refactored imports
2. **Extension load**: `pnpm chrome:build`, load `dist/` in Chrome, verify popup opens and SidePanel renders
3. **Capture flow**: Click capture, verify overlay appears on active tab with drawing tools
4. **Annotation**: Draw all 3 types, verify badges and SVG rendering match existing ScreenshotViewer
5. **Submit flow**: Generate API key in `apps/web` settings, configure in popup, capture + annotate + submit, verify task file appears in project's `.agelum/work/tasks/fixes/`
6. **Site API**: `pnpm site:dev`, POST to `/api/v1/reports` with valid key, verify task creation

---

## Critical Source Files Reference

| File | Relevance |
|------|-----------|
| `apps/web/src/components/features/browser/capture/ScreenshotViewer.tsx` | SVG drawing logic to replicate in overlay |
| `apps/web/src/components/features/browser/panels/TaskPanel.tsx:967-1107` | Burn-in canvas logic to extract |
| `apps/web/src/types/entities.ts:60-72` | `Annotation` + `AnnotationType` to extract |
| `apps/web/src/app/api/(content)/tasks/route.ts` | Task creation logic to replicate in `apps/site` |
| `apps/web/src/lib/settings.ts` | `UserSettings` to extend, `resolveProjectPath` to reuse |
| `packages/shadcn/tsup.config.ts` | Build pattern for new package |
| `apps/web/src/app/globals.css` | Dark theme CSS variables to copy into extension |
